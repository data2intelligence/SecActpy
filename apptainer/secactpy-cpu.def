# =============================================================================
# SecActPy CPU Image (Python only)
#
# Build:
#   apptainer build secactpy-cpu.sif secactpy-cpu.def
#
# Run:
#   apptainer exec secactpy-cpu.sif python3 -c "import secactpy"
#   apptainer shell secactpy-cpu.sif
# =============================================================================

Bootstrap: docker
From: ubuntu:22.04

%labels
    maintainer Seongyong Park <https://github.com/psychemistz>
    description SecActPy - Secreted Protein Activity Inference (CPU)
    org.opencontainers.image.source https://github.com/data2intelligence/SecActpy

%environment
    export DEBIAN_FRONTEND=noninteractive
    export TZ=UTC
    export LANG=en_US.UTF-8
    export LC_ALL=en_US.UTF-8
    export PYTHONUNBUFFERED=1
    export PYTHONDONTWRITEBYTECODE=1

%post
    export DEBIAN_FRONTEND=noninteractive
    export TZ=UTC

    # =========================================================================
    # System Dependencies
    # =========================================================================
    apt-get update && apt-get install -y --no-install-recommends \
        python3 \
        python3-dev \
        python3-pip \
        python3-venv \
        build-essential \
        gfortran \
        cmake \
        pkg-config \
        libcurl4-openssl-dev \
        libssl-dev \
        libxml2-dev \
        libgsl-dev \
        libhdf5-dev \
        libfontconfig1-dev \
        libharfbuzz-dev \
        libfribidi-dev \
        libfreetype6-dev \
        libpng-dev \
        libtiff5-dev \
        libjpeg-dev \
        libcairo2-dev \
        libxt-dev \
        libmagick++-dev \
        libudunits2-dev \
        libgdal-dev \
        libgeos-dev \
        libproj-dev \
        libfftw3-dev \
        libtbb-dev \
        liblapack-dev \
        libblas-dev \
        git \
        wget \
        curl \
        vim \
        locales \
        software-properties-common \
    && rm -rf /var/lib/apt/lists/* \
    && ln -sf /usr/bin/python3 /usr/bin/python

    # Set locale
    locale-gen en_US.UTF-8

    # =========================================================================
    # Python: Install SecActPy
    # =========================================================================
    pip3 install --no-cache-dir --upgrade pip setuptools wheel

    pip3 install --no-cache-dir \
        "numpy>=1.20.0,<2.0.0" \
        pandas \
        scipy \
        h5py \
        anndata \
        scanpy \
        matplotlib \
        seaborn \
        jupyter \
        jupyterlab

    pip3 install --no-cache-dir git+https://github.com/data2intelligence/SecActpy.git

    # Verify
    python3 -c "import secactpy; print(f'SecActPy {secactpy.__version__} OK, GPU: {secactpy.CUPY_AVAILABLE}')"

%runscript
    exec python3 "$@"

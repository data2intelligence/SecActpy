# =============================================================================
# SecActPy CPU + R Image (Python + R SecAct/RidgeR/SpaCET)
#
# Build:
#   apptainer build secactpy-cpu-r.sif secactpy-cpu-r.def
#
# Run:
#   apptainer exec secactpy-cpu-r.sif python3 -c "import secactpy"
#   apptainer exec secactpy-cpu-r.sif R -e "library(SecAct)"
# =============================================================================

Bootstrap: docker
From: ubuntu:22.04

%labels
    maintainer Seongyong Park <https://github.com/psychemistz>
    description SecActPy - Secreted Protein Activity Inference (CPU + R)
    org.opencontainers.image.source https://github.com/data2intelligence/SecActpy

%environment
    export DEBIAN_FRONTEND=noninteractive
    export TZ=UTC
    export LANG=en_US.UTF-8
    export LC_ALL=en_US.UTF-8
    export PYTHONUNBUFFERED=1
    export PYTHONDONTWRITEBYTECODE=1
    export NOT_CRAN=true
    export LIBARROW_BINARY=true

%post
    export DEBIAN_FRONTEND=noninteractive
    export TZ=UTC
    export NOT_CRAN=true
    export LIBARROW_BINARY=true

    # =========================================================================
    # System Dependencies
    # =========================================================================
    apt-get update && apt-get install -y --no-install-recommends \
        python3 \
        python3-dev \
        python3-pip \
        python3-venv \
        build-essential \
        gfortran \
        cmake \
        pkg-config \
        libcurl4-openssl-dev \
        libssl-dev \
        libxml2-dev \
        libgsl-dev \
        libhdf5-dev \
        libfontconfig1-dev \
        libharfbuzz-dev \
        libfribidi-dev \
        libfreetype6-dev \
        libpng-dev \
        libtiff5-dev \
        libjpeg-dev \
        libcairo2-dev \
        libxt-dev \
        libmagick++-dev \
        libudunits2-dev \
        libgdal-dev \
        libgeos-dev \
        libproj-dev \
        libfftw3-dev \
        libtbb-dev \
        liblapack-dev \
        libblas-dev \
        git \
        wget \
        curl \
        vim \
        locales \
        software-properties-common \
    && rm -rf /var/lib/apt/lists/* \
    && ln -sf /usr/bin/python3 /usr/bin/python

    # Set locale
    locale-gen en_US.UTF-8
    export LANG=en_US.UTF-8
    export LC_ALL=en_US.UTF-8

    # =========================================================================
    # R: Install R from CRAN
    # =========================================================================
    echo "Installing R from CRAN repository..."
    wget -qO- https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc \
        | tee -a /etc/apt/trusted.gpg.d/cran_ubuntu_key.asc
    echo "deb https://cloud.r-project.org/bin/linux/ubuntu jammy-cran40/" \
        | tee /etc/apt/sources.list.d/cran.list
    apt-get update
    apt-get install -y --no-install-recommends r-base r-base-dev
    rm -rf /var/lib/apt/lists/*
    R -e "cat('R version:', R.version.string, '\n')"

    # Configure RSPM for pre-compiled R binaries (amd64 only)
    ARCH=$(dpkg --print-architecture)
    if [ "$ARCH" = "amd64" ]; then
        echo 'RSPM=https://packagemanager.posit.co/cran/__linux__/jammy/latest' \
            >> "$(R RHOME)/etc/Renviron.site"
        echo "Configured RSPM for pre-compiled R binaries (amd64)"
    else
        echo "Using CRAN source packages ($ARCH - no RSPM binaries available)"
    fi

    # =========================================================================
    # R: Bioconductor packages
    # =========================================================================
    echo "Installing BiocManager and Bioconductor packages..."
    R -e "options(timeout = 600, repos = c(CRAN = Sys.getenv('RSPM', 'https://cloud.r-project.org/'))); \
          install.packages(c('remotes', 'BiocManager'), Ncpus = parallel::detectCores())"
    R -e "options(timeout = 600); BiocManager::install(ask = FALSE, update = FALSE)"
    R -e "options(timeout = 600); \
          bioc_pkgs <- c( \
              'Biobase', 'S4Vectors', 'IRanges', \
              'SummarizedExperiment', 'SingleCellExperiment', \
              'rhdf5', 'ComplexHeatmap', 'limma', \
              'UCell', 'BiRewire', \
              'sva', 'multtest' \
          ); \
          BiocManager::install(bioc_pkgs, ask = FALSE, update = FALSE, \
              Ncpus = parallel::detectCores()); \
          missing <- bioc_pkgs[!sapply(bioc_pkgs, requireNamespace, quietly = TRUE)]; \
          if (length(missing) > 0) { \
              cat('WARNING: Bioconductor packages failed on first attempt:', \
                  paste(missing, collapse=', '), '\n'); \
              cat('Retrying individually...\n'); \
              for (pkg in missing) { \
                  tryCatch( \
                      BiocManager::install(pkg, ask = FALSE, update = FALSE, \
                          Ncpus = parallel::detectCores()), \
                      error = function(e) cat('  ERROR installing', pkg, ':', \
                          conditionMessage(e), '\n') \
                  ) \
              } \
          }; \
          still_missing <- bioc_pkgs[!sapply(bioc_pkgs, requireNamespace, quietly = TRUE)]; \
          if (length(still_missing) > 0) { \
              cat('WARNING: Could not install Bioconductor packages:', \
                  paste(still_missing, collapse=', '), '\n'); \
              cat('Build will continue; verification step will handle fallback.\n') \
          } else { \
              cat('All', length(bioc_pkgs), 'Bioconductor packages installed OK\n') \
          }"

    # =========================================================================
    # R: CRAN packages
    # =========================================================================
    echo "Installing CRAN packages..."
    R -e "options(timeout = 600, \
              repos = c(CRAN = Sys.getenv('RSPM', 'https://cloud.r-project.org/'))); \
          install.packages(c( \
              'devtools', \
              'Matrix', 'Rcpp', 'RcppArmadillo', 'RcppEigen', 'RcppParallel', \
              'ggplot2', 'dplyr', 'tidyr', 'data.table', \
              'httr', 'jsonlite', 'R6', 'crayon', \
              'reshape2', 'patchwork', 'NMF', 'akima', \
              'gganimate', 'metap', 'circlize', 'ggalluvial', \
              'networkD3', 'survival', 'survminer', 'ggpubr', \
              'car', 'lme4', 'sp', \
              'scatterpie', 'png', 'shiny', 'plotly', 'DT', \
              'factoextra', 'NbClust', 'cluster', 'pbmcapply', \
              'psych', 'RANN', 'sctransform', \
              'irlba', 'igraph', 'Rtsne', 'ROCR', 'entropy' \
          ), dependencies = NA, Ncpus = parallel::detectCores())"

    # =========================================================================
    # R: arrow package (large, separate step)
    # =========================================================================
    echo "Installing arrow package..."
    R -e "options(timeout = 600, \
              repos = c(CRAN = Sys.getenv('RSPM', 'https://cloud.r-project.org/'))); \
          tryCatch({ \
              install.packages('arrow', dependencies = NA, \
                  Ncpus = parallel::detectCores()); \
              library(arrow); \
              cat('arrow', as.character(packageVersion('arrow')), 'OK\n') \
          }, error = function(e) { \
              cat('WARNING: arrow install failed:', conditionMessage(e), '\n'); \
              cat('Retrying with LIBARROW_BINARY=TRUE...\n'); \
              Sys.setenv(LIBARROW_BINARY = 'TRUE', NOT_CRAN = 'TRUE'); \
              install.packages('arrow', dependencies = NA, \
                  Ncpus = parallel::detectCores()); \
              library(arrow); \
              cat('arrow', as.character(packageVersion('arrow')), 'OK (retry)\n') \
          })"

    # =========================================================================
    # R: Verify pre-installed dependencies
    # =========================================================================
    echo "Verifying pre-installed R dependencies..."
    R -e "required <- c( \
              'Matrix', 'ggplot2', 'reshape2', 'patchwork', 'NMF', 'akima', \
              'gganimate', 'metap', 'circlize', 'ggalluvial', 'networkD3', \
              'survival', 'survminer', 'ComplexHeatmap', \
              'RcppParallel', \
              'jsonlite', 'scatterpie', 'png', 'shiny', 'plotly', 'DT', \
              'factoextra', 'NbClust', 'cluster', 'pbmcapply', 'psych', \
              'arrow', 'RANN', 'sctransform', 'UCell', 'BiRewire', 'limma', \
              'sva', 'irlba', 'igraph', 'Rtsne', 'ROCR', 'entropy' \
          ); \
          cat('Checking', length(required), 'required packages...\n'); \
          status <- sapply(required, requireNamespace, quietly = TRUE); \
          for (i in seq_along(required)) { \
              cat(sprintf('  %-20s %s\n', required[i], \
                  if (status[i]) 'OK' else 'MISSING')) \
          }; \
          missing <- required[!status]; \
          if (length(missing) > 0) { \
              cat('\nWARNING:', length(missing), 'packages missing after initial install:\n'); \
              cat('  ', paste(missing, collapse=', '), '\n'); \
              cat('Attempting fallback install via BiocManager...\n'); \
              options(timeout = 600, \
                  repos = c(CRAN = Sys.getenv('RSPM', 'https://cloud.r-project.org/'))); \
              for (pkg in missing) { \
                  cat('  Installing', pkg, '...\n'); \
                  tryCatch( \
                      BiocManager::install(pkg, ask = FALSE, update = FALSE, \
                          Ncpus = parallel::detectCores()), \
                      error = function(e) cat('    FAILED:', conditionMessage(e), '\n') \
                  ) \
              } \
          }; \
          still_missing <- required[!sapply(required, requireNamespace, quietly = TRUE)]; \
          if (length(still_missing) > 0) { \
              cat('\n========================================\n'); \
              cat('FATAL: Cannot install required packages:\n'); \
              for (pkg in still_missing) cat('  -', pkg, '\n'); \
              cat('========================================\n'); \
              stop(paste('FATAL: Cannot install required packages:', \
                  paste(still_missing, collapse=', '))) \
          } else { \
              cat('\nAll', length(required), 'required R packages verified OK\n') \
          }"

    # =========================================================================
    # R: GitHub packages (MUDAN, RidgeR, SecAct, SpaCET)
    # =========================================================================
    echo "Installing MUDAN from GitHub..."
    R -e "options(timeout = 600); \
          tryCatch({ \
              remotes::install_github('JEFworks/MUDAN', \
                  dependencies = FALSE, force = TRUE); \
              library(MUDAN); \
              cat('MUDAN', as.character(packageVersion('MUDAN')), 'OK\n') \
          }, error = function(e) { \
              message('First attempt failed: ', conditionMessage(e)); \
              message('Retrying with dependencies...'); \
              remotes::install_github('JEFworks/MUDAN', \
                  dependencies = NA, force = TRUE); \
              library(MUDAN); \
              cat('MUDAN', as.character(packageVersion('MUDAN')), 'OK (with deps)\n') \
          })"

    echo "Installing RidgeR from GitHub..."
    R -e "options(timeout = 600); \
          tryCatch({ \
              remotes::install_github('beibeiru/RidgeR', \
                  dependencies = FALSE, force = TRUE); \
              library(RidgeR); \
              cat('RidgeR', as.character(packageVersion('RidgeR')), 'OK\n') \
          }, error = function(e) { \
              message('First attempt failed: ', conditionMessage(e)); \
              message('Retrying with dependencies...'); \
              remotes::install_github('beibeiru/RidgeR', \
                  dependencies = NA, force = TRUE); \
              library(RidgeR); \
              cat('RidgeR', as.character(packageVersion('RidgeR')), 'OK (with deps)\n') \
          })"

    echo "Installing SecAct from GitHub..."
    R -e "options(timeout = 600); \
          tryCatch({ \
              remotes::install_github('data2intelligence/SecAct', \
                  dependencies = FALSE, force = TRUE); \
              library(SecAct); \
              cat('SecAct', as.character(packageVersion('SecAct')), 'OK\n') \
          }, error = function(e) { \
              message('First attempt failed: ', conditionMessage(e)); \
              message('Retrying with dependencies...'); \
              remotes::install_github('data2intelligence/SecAct', \
                  dependencies = NA, force = TRUE); \
              library(SecAct); \
              cat('SecAct', as.character(packageVersion('SecAct')), 'OK (with deps)\n') \
          })"

    echo "Installing SpaCET from GitHub..."
    R -e "options(timeout = 600); \
          tryCatch({ \
              remotes::install_github('data2intelligence/SpaCET', \
                  dependencies = FALSE, force = TRUE); \
              library(SpaCET); \
              cat('SpaCET', as.character(packageVersion('SpaCET')), 'OK\n') \
          }, error = function(e) { \
              message('First attempt failed: ', conditionMessage(e)); \
              message('Retrying with dependencies...'); \
              remotes::install_github('data2intelligence/SpaCET', \
                  dependencies = NA, force = TRUE); \
              library(SpaCET); \
              cat('SpaCET', as.character(packageVersion('SpaCET')), 'OK (with deps)\n') \
          })"

    # Verify R GitHub packages
    echo "Verifying R installation..."
    R -e "cat('R version:', R.version.string, '\n'); \
          required <- c('RidgeR', 'SecAct', 'SpaCET'); \
          all_ok <- TRUE; \
          for (pkg in required) { \
              if (requireNamespace(pkg, quietly = TRUE)) { \
                  cat(pkg, as.character(packageVersion(pkg)), 'OK\n') \
              } else { \
                  cat(pkg, 'MISSING\n'); \
                  all_ok <- FALSE \
              } \
          }; \
          if (!all_ok) stop('Required R packages are missing!')"

    # =========================================================================
    # Python: Install SecActPy
    # =========================================================================
    pip3 install --no-cache-dir --upgrade pip setuptools wheel

    pip3 install --no-cache-dir \
        "numpy>=1.20.0,<2.0.0" \
        pandas \
        scipy \
        h5py \
        anndata \
        scanpy \
        matplotlib \
        seaborn \
        jupyter \
        jupyterlab

    pip3 install --no-cache-dir git+https://github.com/data2intelligence/SecActpy.git

    # Verify Python
    python3 -c "import secactpy; print(f'SecActPy {secactpy.__version__} OK, GPU: {secactpy.CUPY_AVAILABLE}')"

%runscript
    exec python3 "$@"
